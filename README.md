# Shutdown Button for Raspberry Pi

A very simple systemd service for Raspberry Pi that provides a
software-controlled restart / shutdown button.

You can make a ON/OFF button for your Crankshaft head unit using `GPIO3` and `GPIO27` pins.

Note: You need a 5 pin relay and the shutdown/reboot script.

## Instructions

### Boot

`GPIO3` wakes up the Pi from halt state by default (short pin 5 to ground)

### Reboot/shutdown

This [reboot/shutdown script](https://github.com/scruss/shutdown_button) could be helpful.

If you buy a simple 12 volt relay you can trigger boot / shutdown with your car's ignition.

Same like any car stereo works.

You need to connect the coil of the relay (pin86) to your switched power line (the line which is powered when ignition is on) and (pin85) to ground.
The switch contact 87 of the relay (normally OPEN) you connect to pin 5 (GPIO3).
The switch contact 87a of the relay (normally CLOSE) you connect to pin 13 (GPIO27).
The common contact 30 of the relay you connect to pin 6 (GROUND)

### Function

When you turn on the ignition the relay gets 12 volts and closes the relay Switch(87/30).
This sets GPIO3 to LOW and your Pi will boot.

When you turn the ignition OFF  the relay closes the Switch contacts(87a/30) and GPIO27 is set LOW. The Pi shuts down when ignition is off for at least 5 seconds (TIME is setable in the script)

## Relay with wiring harness

![](https://www.amazon.com/gp/product/B01N66W2XF/)

https://www.amazon.com/gp/product/B01N66W2XF/

Above is a link to Amazon but any other 12 volt/5 pin relay will work!

## Relay connectors

```
pin 86=   SWITCHED power(ignition)
pin 85=   Chassis Ground (Vehicle electrical system ground)
pin 30=   GPIO Physical Pin 6 or USB ground(Raspberry Pi/USB Ground)
pin 87a=  GPIO Physical Pin 13 (RPI GPIO 27)
pin 87=   GPIO Physical Pin 5 (RPI GPIO 3)
```
**Raspberry Pi GPIO pins:** https://www.raspberrypi.org/documentation/usage/gpio/images/gpio-pins-pi2.jpg

**Raspberry Pi GPIO Pin Numbers:** https://www.raspberrypi.org/documentation/usage/gpio/images/gpio-numbers-pi2.png

**Relay Wiring Pinout:** https://images-na.ssl-images-amazon.com/images/I/71vF%2BJbm5bL._SL1500_.jpg


NOTE:

You can edit the shutdown and reboot times in the script.
Default time for reboot is 2 seconds and default time for shutdown is 5 seconds.

That means if you turn the car's ignition OFF the Pi will shutdown after 5 seconds.
But if you turn the ignition OFF for just 2 seconds, then turn the ignition ON again, the Pi will reboot.
I suggest setting the reboot time to 5 seconds and the shutdown time to 10 seconds to avoid unwanted reboots when starting your car's engine which causes the relay to lose power.

P.S. Note: Unfortunately GPIO3 is on the same pin as SCL. So if you keep this pin grounded with a relay when the car, and the pi, are on, you can't use I2C.

### Software

The software is installed with the following commands:

    sudo apt install python3-gpiozero
    sudo mkdir -p /usr/local/bin
    chmod +x shutdown_button.py
    sudo cp shutdown_button.py /usr/local/bin
    sudo cp shutdown_button.service /etc/systemd/system
    sudo systemctl enable shutdown_button.service
    sudo systemctl start shutdown_button.service

## Troubleshooting

Enabling the service should produce output very similar to:

    Created symlink /etc/systemd/system/multi-user.target.wants/shutdown_button.service → /etc/systemd/system/shutdown_button.service.

You can check the status of the program at any time with the command:
	
    systemctl status shutdown_button.service

This should produce output similar to:
	
    ● shutdown_button.service - GPIO shutdown button
       Loaded: loaded (/etc/systemd/system/shutdown_button.service; enabled; vendor 
       Active: active (running) since Sat 2017-10-21 11:20:56 EDT; 27s ago
     Main PID: 3157 (python3)
       CGroup: /system.slice/shutdown_button.service
               └─3157 /usr/bin/python3 /usr/local/bin/shutdown_button.py

    Oct 21 11:20:56 naan systemd[1]: Started GPIO shutdown button.

If you're seeing anything *other* than **Active: active (running)**,
it's not working. Does the Python script have the right permissions?
Is it in the right place? If you modified the script, did you check it
for syntax errors? If you're using a model A or B with a 26-pin GPIO connector, did you make the modifications in the Python script to use GPIO 17 instead of 27?

The output from `dmesg` will show you any error messages generated by
the service.

## Modifications

If you use a HAT/pHAT/Bonnet/etc. with your Raspberry Pi, check
[pinout.xyz](https://pinout.xyz/) to see if it uses BCM 27. If you do
need to change the pin, best to pick one that doesn't have a useful
system service like serial I/O or SPI. If you're using an ATX button
with a two pin connector, make sure you choose a pin physically
adjacent to a ground pin.

If you modify the timing, please ensure that you keep the shutdown
button press duration *longer* than the reboot one. Otherwise you'll
only be able to shut down.

## Notes

You should not need to reboot to enable the service. One machine of
mine — a Raspberry Pi Zero running Raspbian Stretch — did need a
reboot before the button worked.

The reboot code is based on the [Shutdown
button](https://gpiozero.readthedocs.io/en/stable/recipes.html#shutdown-button)
example from the GPIO Zero documentation.

This is not the only combined shutdown/reset button project to use
GPIO Zero. [gilyes/pi-shutdown](https://github.com/gilyes/pi-shutdown)
also does so, but pre-dates the implementation of the various hold
time functions in GPIO Zero.

GPIO 27 was used, as it's broken out onto a physical button on the Adafruit [PiTFT+](http://adafru.it/2423) display I own.

This is my first systemd service, and I'm still at the “amazed it
works at all” stage. The service file may not contain the ideal
configuration.

### Connector Pinouts

From GPIO Zero's `pinout` command

#### 40 pin

       3V3  (1) (2)  5V    
     GPIO2  (3) (4)  5V    
     GPIO3  (5) (6)  GND   
     GPIO4  (7) (8)  GPIO14
       GND  (9) (10) GPIO15
    GPIO17 (11) (12) GPIO18
    GPIO27 (13) (14) GND   
    GPIO22 (15) (16) GPIO23
       3V3 (17) (18) GPIO24
    GPIO10 (19) (20) GND   
     GPIO9 (21) (22) GPIO25
    GPIO11 (23) (24) GPIO8 
       GND (25) (26) GPIO7 
     GPIO0 (27) (28) GPIO1 
     GPIO5 (29) (30) GND   
     GPIO6 (31) (32) GPIO12
    GPIO13 (33) (34) GND   
    GPIO19 (35) (36) GPIO16
    GPIO26 (37) (38) GPIO20
       GND (39) (40) GPIO21
    
#### 26 pin

       3V3  (1) (2)  5V    
     GPIO0  (3) (4)  5V    
     GPIO1  (5) (6)  GND   
     GPIO4  (7) (8)  GPIO14
       GND  (9) (10) GPIO15
    GPIO17 (11) (12) GPIO18
    GPIO21 (13) (14) GND   
    GPIO22 (15) (16) GPIO23
       3V3 (17) (18) GPIO24
    GPIO10 (19) (20) GND   
     GPIO9 (21) (22) GPIO25
    GPIO11 (23) (24) GPIO8 
       GND (25) (26) GPIO7 
    
## Refrences

Stewart C. Russell — [scruss.com](https://scruss.com/blog/) —
[@scruss](https://twitter.com/scruss).

opencardev

